# LPIR Improvements Review and Testing Plan

## Overview

This document reviews the current LPIR improvements implementation against `docs/plans/16-lpir-improvements-for-backend.md`, identifies issues, and outlines comprehensive testing requirements.

## Implementation Status Review

### ✅ Implemented Features

1. **Operand Classification** (`crates/lpc-lpir/src/dfg/operand.rs`)

   - `OperandKind` enum (Use, Def, Modify)
   - `DFG::operand_kinds()` method
   - `DFG::has_modify_operands()` method

2. **Instruction Query Methods** (`crates/lpc-lpir/src/dfg/opcode.rs`)

   - `Opcode::is_call()`
   - `Opcode::is_terminator()`
   - `Opcode::is_memory_access()`
   - `Opcode::has_side_effects()`

3. **Multi-Return Support** (`crates/lpc-lpir/src/function.rs`)

   - `Function::return_count()`
   - `Function::uses_multi_return()`
   - `Function::return_types()`

4. **Value-to-Instruction Mapping** (`crates/lpc-lpir/src/function.rs`)

   - `Function::value_def()`
   - `Function::value_uses()`
   - `Function::is_block_param()`
   - `Function::is_function_param()`

5. **Block Parameter Source Tracking** (`crates/lpc-lpir/src/function.rs`)

   - `Function::block_param_sources()`

6. **Return Instruction Validation** (`crates/lpc-lpir/src/verifier/format.rs`)

   - Validates return count matches function signature
   - Validates return value types match signature

7. **Module-Level Verification** (`crates/lpc-lpir/src/verifier/mod.rs`)
   - `verify_module()` function
   - Cross-function call/return validation

## Issues to Fix

### Issue 1: Return Instruction Structure Bug (CONFIRMED via Cranelift)

**File**: `crates/lpc-lpir/src/dfg/inst_data.rs` (lines 200-208)

**Problem**: `InstData::return_()` incorrectly sets both `args` and `results` to the same values.

**Cranelift's Design** (confirmed in `/Users/yona/dev/photomancer/wasmtime/cranelift/codegen/src/verifier/mod.rs:1646-1659`):

- Return instructions use `args` for the return values (they consume the values being returned)
- Return instructions have **no results** (they don't produce values, they terminate execution)
- The verifier checks `args` against the function signature, not `results`

**Current Code**:

```rust
pub fn return_(values: Vec<Value>) -> Self {
    Self {
        opcode: crate::dfg::opcode::Opcode::Return,
        args: values.clone(),
        results: values,  // ❌ WRONG: should be Vec::new()
        // ...
    }
}
```

**Fix**: Change `InstData::return_()` to set `results: Vec::new()` instead of `results: values`.

### Issue 2: Return Instruction Validation Bug (CONFIRMED via Cranelift)

**File**: `crates/lpc-lpir/src/verifier/format.rs` (lines 315-336)

**Problem**:

1. Return instruction validation checks `inst_data.results.len()` against the function signature, but should check `inst_data.args.len()` (as Cranelift does)
2. Checks that `args.len() == results.len()` which is incorrect - results should be 0
3. Type checking uses `args` correctly, but count checking uses `results`

**Current Code**:

```rust
Opcode::Return => {
    if inst_data.args.len() != inst_data.results.len() {  // ❌ WRONG
        // ...
    }
    if inst_data.results.len() != function.signature.returns.len() {  // ❌ WRONG
        // ...
    }
    // Type checking correctly uses args:
    for (i, ret_value) in inst_data.args.iter().enumerate() {  // ✅ CORRECT
        // ...
    }
}
```

**Fix**:

- Change validation to check `inst_data.args.len()` against `function.signature.returns.len()`
- Verify that `inst_data.results.len() == 0` for Return instructions
- Remove the incorrect `args.len() == results.len()` check

## Missing Tests

### 1. Operand Classification Tests

**File**: `crates/lpc-lpir/src/dfg/mod.rs` (add to existing test module)

- Test `operand_kinds()` for arithmetic instructions (should return Use for args, Def for results)
- Test `operand_kinds()` for instructions with no args (e.g., constants)
- Test `operand_kinds()` for instructions with no results (e.g., Store, Return)
- Test `has_modify_operands()` (should return false for all current instructions)

### 2. Opcode Query Method Tests

**File**: `crates/lpc-lpir/src/dfg/opcode.rs` (add to existing test module)

- Test `is_call()` - true for Call, false for others
- Test `is_terminator()` - true for Jump, Br, Return, Halt, Trap variants; false for others
- Test `is_memory_access()` - true for Load/Store, false for others
- Test `has_side_effects()` - true for Store, Call, Syscall, Return, Trap variants; false for others

### 3. Multi-Return Helper Method Tests

**File**: `crates/lpc-lpir/src/function.rs` (add to existing test module)

- Test `return_count()` - returns correct count for 0, 1, 2, 3+ returns
- Test `uses_multi_return()` - true for 3+ returns, false for ≤2
- Test `return_types()` - returns correct slice of return types

### 4. Value-to-Instruction Mapping Tests

**File**: `crates/lpc-lpir/src/function.rs` (add to existing test module)

- Test `value_def()` - finds instruction that defines a value
- Test `value_def()` - returns None for block parameters
- Test `value_def()` - returns None for function parameters
- Test `value_uses()` - finds all instructions using a value
- Test `value_uses()` - handles multiple uses of same value
- Test `value_uses()` - includes uses in block_args
- Test `is_block_param()` - correctly identifies block parameters
- Test `is_block_param()` - returns None for non-parameter values
- Test `is_function_param()` - correctly identifies function parameters (entry block params)
- Test `is_function_param()` - returns None for non-function-parameter values

### 5. Block Parameter Source Tracking Tests

**File**: `crates/lpc-lpir/src/function.rs` (add to existing test module)

- Test `block_param_sources()` - finds sources from single predecessor
- Test `block_param_sources()` - finds sources from multiple predecessors
- Test `block_param_sources()` - handles jump with args
- Test `block_param_sources()` - handles branch with args
- Test `block_param_sources()` - returns empty for invalid param index
- Test `block_param_sources()` - returns empty for block with no predecessors

### 6. Multi-Return Validation Tests

**File**: `crates/lpc-lpir/src/verifier/format.rs` (add to existing test module)

- Test return with 3+ values matching signature (should pass)
- Test return with wrong count (should fail)
- Test return with wrong types (should fail)
- Test return with 0 values for void function (should pass)
- Test return with results field set (should fail - results must be empty)

### 7. Module-Level Verification Tests

**File**: `crates/lpc-lpir/src/verifier/mod.rs` (add to existing test module)

- Test `verify_module()` - validates call with correct signature (should pass)
- Test `verify_module()` - validates call with wrong arg count (should fail)
- Test `verify_module()` - validates call with wrong result count (should fail)
- Test `verify_module()` - validates call with 3+ results (multi-return)
- Test `verify_module()` - validates multiple functions in module

## Implementation Steps

1. **Fix Return Instruction Structure Bug**

   - Update `InstData::return_()` in `inst_data.rs` to set `results: Vec::new()`
   - Verify this doesn't break existing code that might rely on the bug

2. **Fix Return Instruction Validation Bug**

   - Update `verify_instruction_format()` in `format.rs` to check `args` instead of `results`
   - Remove incorrect `args.len() == results.len()` check
   - Add check that `results.len() == 0` for Return instructions

3. **Add Operand Classification Tests**

   - Add tests to `crates/lpc-lpir/src/dfg/mod.rs`

4. **Add Opcode Query Method Tests**

   - Add tests to `crates/lpc-lpir/src/dfg/opcode.rs`

5. **Add Multi-Return Helper Tests**

   - Add tests to `crates/lpc-lpir/src/function.rs`

6. **Add Value Mapping Tests**

   - Add comprehensive tests to `crates/lpc-lpir/src/function.rs`

7. **Add Block Parameter Source Tests**

   - Add tests to `crates/lpc-lpir/src/function.rs`

8. **Add Multi-Return Validation Tests**

   - Add tests to `crates/lpc-lpir/src/verifier/format.rs`

9. **Add Module Verification Tests**

   - Add tests to `crates/lpc-lpir/src/verifier/mod.rs`

10. **Run All Tests**

    - Ensure all new tests pass
    - Ensure existing tests still pass (may need updates if they relied on the Return bug)

11. **Format and Check**
    - Run `just fmt` to format code
    - Run `just check` to verify everything passes

## Related Documents

- `docs/plans/16-lpir-improvements-for-backend.md` - Original plan
- `docs/plans/17-backend3.md` - Backend3 architecture plan

