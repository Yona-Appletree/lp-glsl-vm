# Update LPIR Format to Explicit Phi Value Syntax

## Overview

Change LPIR to explicitly show which values are passed to block parameters, matching CLIF syntax. This makes phi node handling explicit and easier to understand.

## Current State

- `jump block3` - no explicit values
- `brif v0, block1, block2` - no explicit values
- Values are inferred via `compute_phi_sources()` using liveness analysis

## Target State

- `jump block3(v1)` - explicitly shows v1 is passed to block3's first parameter
- `brif v0, block1(v1), block2(v2)` - explicitly shows values for each branch target
- Values are taken directly from the instruction, eliminating inference

## Changes Required

### 1. Update `Inst` enum (`crates/lpc-lpir/src/inst.rs`)

- Change `Jump { target: u32 }` to `Jump { target: u32, args: Vec<Value> }`
- Change `Br { condition, target_true, target_false }` to `Br { condition, target_true: u32, args_true: Vec<Value>, target_false: u32, args_false: Vec<Value> }`
- Update `args()` method to include jump/branch args in the returned Vec
- Update `Display` impl:
  - `Jump`: Write `jump block3(v1, v2)` - show args in parentheses, empty if no args
  - `Br`: Write `brif v0, block1(v1), block2(v2)` - show args for both targets, empty parentheses if no args

### 2. Update Parser (`crates/lpc-lpir/src/parser/instructions.rs`)

- Update `parse_jump()`:

  - Parse `jump` keyword
  - Parse block index: `block3`
  - Parse optional value list in parentheses: `(v1, v2, ...)` using `separated_list0` with comma separator
  - Return `Inst::Jump { target, args }` where args is empty vec if no parentheses present
  - Syntax: `jump block3` (no args) or `jump block3(v1, v2)` (with args)

- Update `parse_branch()`:

  - Parse `brif` keyword
  - Parse condition value: `v0`
  - Parse comma separator
  - Parse first target: `block1` followed by optional `(v1, v2, ...)`
  - Parse comma separator
  - Parse second target: `block2` followed by optional `(v3, v4, ...)`
  - Return `Inst::Br { condition, target_true, args_true, target_false, args_false }`
  - Syntax: `brif v0, block1, block2` (no args) or `brif v0, block1(v1), block2(v2)` (with args)

- Use existing `parse_value` and `separated_list0` combinators similar to how `parse_call` handles args
- Args are REQUIRED when target block has parameters (will be enforced by tests, not parser)

### 3. Update Builder (`crates/lpc-lpir/src/builder/block_builder.rs`)

- Update `jump()` method to accept optional `args: &[Value]` parameter
- Update `br()` method to accept optional `args_true: &[Value]` and `args_false: &[Value]` parameters

### 4. Update Lowering (`crates/lpc-riscv32/src/backend/lower/branch.rs`)

- Update `lower_jump()` to accept `args: &[Value] `and copy them directly to target block parameters (instead of using `copy_phi_values()`)
- Update `lower_br()` to accept `args_true: &[Value]` and `args_false: &[Value]` and copy them directly
- Remove dependency on phi source inference for these instructions

### 5. Update Lowerer (`crates/lpc-riscv32/src/backend/lower/mod.rs`)

- Update `lower_inst()` to pass args from `Inst::Jump` and `Inst::Br` to lowering functions
- Can eventually remove or simplify `compute_phi_sources()` (but keep for now in case other code uses it)

### 6. Update Tests

**CRITICAL: This will break ALL existing tests that use jump/branch instructions. They MUST be fixed.**

- Update parser tests in `crates/lpc-lpir/src/parser/instructions.rs`:

  - Update `test_parse_jump()` to test both `jump block1` and `jump block1(v1)` forms
  - Update `test_parse_branch()` to test both `brif v0, block1, block2` and `brif v0, block1(v1), block2(v2)` forms
  - Add tests for empty args vs non-empty args

- Update phi tests in `crates/lpc-riscv32/src/backend/tests/phi_tests.rs`:

  - **ALL** IR strings must be updated to include explicit args when blocks have parameters
  - Example: `jump block3` → `jump block3(v1)` when block3 has parameter v3 that receives v1
  - Example: `brif v0, block1, block2` → `brif v0, block1(v1), block2(v2)` when blocks have parameters

- Search for all test files that use jump/branch:

  - `grep -r "jump block" crates/` - find all jump usages
  - `grep -r "brif" crates/` - find all branch usages
  - Update every single one to include explicit args

- Update any tests that construct `Inst::Jump` or `Inst::Br` directly (e.g., in builder tests)

### 7. Update Documentation

- Update any documentation that shows LPIR examples
- Update `docs/plans/10.3-phi-nodes.md` to reflect explicit syntax

## Implementation Order

1. Update `Inst` enum (`crates/lpc-lpir/src/inst.rs`):

   - Add `args` field to `Jump`
   - Add `args_true` and `args_false` fields to `Br`
   - Update `args()` method to include these args
   - Update `Display` impl to format with parentheses and value lists

2. Update Parser (`crates/lpc-lpir/src/parser/instructions.rs`):

   - Update `parse_jump()` to parse optional `(v1, v2, ...)` after block index
   - Update `parse_branch()` to parse optional args for both targets
   - Use `opt(delimited(...))` pattern similar to `parse_call` for value lists

3. Update Display impl (already in step 1, but verify):

   - Test that `jump block3(v1, v2)` formats correctly
   - Test that `brif v0, block1(v1), block2(v2)` formats correctly
   - Test empty args: `jump block3()` and `brif v0, block1(), block2()`

4. Update Lowering (`crates/lpc-riscv32/src/backend/lower/branch.rs`):

   - Update `lower_jump()` signature to accept `args: &[Value]`
   - Replace `copy_phi_values()` call with direct copying from `args` to target block parameters
   - Update `lower_br()` signature to accept `args_true: &[Value]` and `args_false: &[Value]`
   - Replace `copy_phi_values()` calls with direct copying from args

5. Update Lowerer (`crates/lpc-riscv32/src/backend/lower/mod.rs`):

   - Update `lower_inst()` match arms for `Inst::Jump` and `Inst::Br` to extract and pass args

6. Update Builder (`crates/lpc-lpir/src/builder/block_builder.rs`):

   - Update `jump()` method to accept `args: &[Value]` parameter (default to empty slice)
   - Update `br()` method to accept `args_true: &[Value]` and `args_false: &[Value]` parameters

7. **Fix ALL broken tests** (this is the critical step):

   - Run `cargo test` - expect many failures
   - Systematically update every test IR string to include explicit args
   - Update any direct `Inst::Jump`/`Inst::Br` constructions

8. Update Documentation:
   - Update `docs/plans/10.3-phi-nodes.md` to show new explicit syntax
   - Update any other docs with LPIR examples

## Breaking Changes

**NO backward compatibility. This is a breaking change.**

- All existing IR strings with `jump` or `brif` will need to be updated
- All tests will fail until updated
- The implicit phi inference approach is fundamentally wrong and must be replaced
- Args are REQUIRED when target blocks have parameters (enforced by test failures, not parser)
